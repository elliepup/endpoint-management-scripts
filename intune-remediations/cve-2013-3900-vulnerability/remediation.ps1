# File: detection.ps1
# Description: This script is used to detect if the vulnerability is present on the device. To be used in conjunction with the remediation script.
# Author: Nicholas Tabb
# Date: 11/17/2023
# Version: 1.0 - Initial Release

$keys = @("HKLM:\Software\Microsoft\Cryptography\Wintrust\Config", "HKLM:\Software\WOW6432Node\Microsoft\Cryptography\Wintrust\Config")
$keyName = "EnableCertPaddingCheck"

# if key does not exist at either path, create it; set value to 1 regardless
foreach ($key in $keys) {
    if (!(Test-Path -Path $key)) {
        New-Item -Path $key -Force | Out-Null
    }
    New-ItemProperty -Path $key -Name $keyName -Value 1 -PropertyType DWORD -Force | Out-Null
}

# see if all keys have value 1; exit 1 if not, else exit 0
foreach ($key in $keys) {
    $keyValue = Get-ItemProperty -Path $key -Name $keyName | Select-Object -ExpandProperty $keyName
    if ($keyValue -ne 1) {
        Write-Host "Key $key still does not have value 1, remediation failed. May require manual intervention."
        exit 1
    }
}

Write-Host "All keys now have value 1, no remediation required."
exit 0