# File: detection.ps1
# Description: This script is used to detect if the vulnerability is present on the device. To be used in conjunction with the remediation script.
# Author: Nicholas Tabb
# Date: 11/17/2023
# Version: 1.0 - Initial Release

$keys = @("HKLM:\Software\Microsoft\Cryptography\Wintrust\Config", "HKLM:\Software\WOW6432Node\Microsoft\Cryptography\Wintrust\Config")
$property = "EnableCertPaddingCheck"
$value = 1

# if either of them do not exist or value is not $value, exit 1
foreach ($key in $keys) {
    if (!(Test-Path -Path $key)) {
        Write-Host "Key $key does not exist, requires remediation"
        exit 1
    }
    $keyValue = Get-ItemProperty -Path $key -Name $property | Select-Object -ExpandProperty $property
    if ($keyValue -ne $value) {
        Write-Host "Key $key does not have value $value, requires remediation"
        exit 1
    }
}

Write-Host "All keys have value $value, no remediation required"
exit 0
